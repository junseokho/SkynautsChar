<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>탐공사 캐릭터 생성기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    /* Sky & Machine Theme Color Scheme */
    :root {
      --sky-light: #e8f1ff;
      --sky-main: #0099cc;
      --accent-blue: #00b8e6;
      --sky-dark: #0066aa;
      --machine-dark: #1a1f2e;
      --machine-gray: #374151;
      --machine-light: #e2e8f0;
      /* New radius variables for consistent styling */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 12px;
    }

    body {
      font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      /* Updated background gradient for a softer look */
      background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 50%, #f8fbff 100%);
      color: var(--machine-dark);
      font-size: 15px;
      font-weight: 400;
      letter-spacing: 0.3px;
    }

    h1, h2, h3 {
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    h1 {
      font-size: 28px;
      margin: 0 0 8px 0;
    }

    header {
      background: linear-gradient(135deg, var(--sky-main) 0%, var(--accent-blue) 100%);
      color: #ffffff;
      /* Increased padding and removed border for a cleaner look */
      padding: 20px 24px;
      border-bottom: none;
      box-shadow: 0 8px 24px rgba(0, 99, 170, 0.15);
    }

    header h1 {
      margin: 0;
      /* Slightly larger font size for header */
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    h2 {
      font-size: 18px;
      margin: 0 0 6px 0;
      font-weight: 600;
    }

    main {
      max-width: 1000px;
      /* Increased margin for better spacing */
      margin: 32px auto 40px;
      padding: 0 16px;
    }

    /* Improved card design with modern shadows and rounded corners */
    .card {
      background-color: #ffffff;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 99, 170, 0.06), 0 8px 24px rgba(26, 31, 46, 0.08);
      margin-bottom: 20px;
      border: none;
      border-top: 4px solid var(--accent-blue);
      position: relative;
      transition: box-shadow 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 99, 170, 0.1), 0 12px 32px rgba(26, 31, 46, 0.12);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, rgba(0, 184, 230, 0.04) 0%, transparent 70%);
      border-radius: var(--radius-lg) 0 0 0;
      pointer-events: none;
    }

    .card h2 {
      margin-top: 0;
      font-size: 18px;
      border-bottom: 2px solid var(--sky-light);
      padding-bottom: 12px;
      margin-bottom: 16px;
      color: var(--sky-main);
      font-weight: 700;
    }

    label {
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.2px;
      color: var(--machine-dark);
      display: block;
      margin-bottom: 6px;
    }

    /* Improved input styling with rounded corners and better focus states */
    input[type="text"],
    textarea,
    select {
      font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      font-weight: 400;
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 2px solid #cbd5e1;
      background-color: #f8fafc;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      background-color: #ffffff;
      border-color: var(--sky-main);
      box-shadow: 0 0 0 4px rgba(0, 99, 170, 0.12);
    }

    textarea {
      resize: vertical;
      min-height: 90px;
      font-family: inherit;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
    }

    .col-2 {
      flex: 1 1 220px;
    }

    .field-group {
      margin-bottom: 16px;
    }

    .hint {
      font-size: 13px;
      color: #64748b;
      margin-top: 4px;
      line-height: 1.5;
    }

    /* Improved badge styling */
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--sky-light) 0%, rgba(0, 184, 230, 0.1) 100%);
      color: var(--sky-main);
      margin-left: 6px;
      font-weight: 700;
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .section-title {
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--machine-dark);
    }

    /* Modern button design with improved hover effects */
    button {
      border-radius: var(--radius-sm);
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--sky-main) 0%, var(--accent-blue) 100%);
      color: #ffffff;
      transition: all 0.2s ease;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0, 99, 170, 0.2);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transition: left 0.3s ease;
    }

    button:hover {
      background: linear-gradient(135deg, var(--sky-dark) 0%, var(--sky-main) 100%);
      box-shadow: 0 6px 16px rgba(0, 99, 170, 0.3);
      transform: translateY(-2px);
    }

    button:hover::before {
      left: 100%;
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b 0%, var(--machine-gray) 100%);
      box-shadow: 0 4px 12px rgba(55, 65, 81, 0.2);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569 0%, #64748b 100%);
      box-shadow: 0 6px 16px rgba(55, 65, 81, 0.3);
    }

    /* Improved skill preview styling */
    .skill-preview {
      font-size: 13px;
      background-color: #f8fafc;
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      border: 2px solid #cbd5e1;
      border-left: 4px solid var(--accent-blue);
      white-space: pre-line;
      font-family: 'JetBrains Mono', monospace;
      line-height: 1.6;
      color: var(--machine-dark);
      font-weight: 500;
    }

    .skill-cards-container {
      display: none;
      margin-top: 8px;
      border-radius: var(--radius-md);
      border: 2px solid #cbd5e1;
      border-top: 4px solid var(--sky-main);
      padding: 12px;
      background-color: #f8fafc;
      max-height: 320px;
      overflow: auto;
    }

    .skill-category-block {
      margin-bottom: 12px;
    }

    .skill-category-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--sky-main);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .skill-card-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Modern skill card design */
    .skill-card {
      border-radius: var(--radius-sm);
      border: 2px solid #cbd5e1;
      padding: 6px 12px;
      font-size: 13px;
      background-color: #ffffff;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s ease;
      position: relative;
      font-weight: 500;
    }

    .skill-card:hover {
      border-color: var(--sky-main);
      box-shadow: 0 4px 12px rgba(0, 99, 170, 0.2);
      transform: translateY(-2px);
    }

    .skill-card.selected {
      background: linear-gradient(135deg, var(--sky-main) 0%, var(--accent-blue) 100%);
      color: #ffffff;
      border-color: var(--sky-dark);
      box-shadow: 0 4px 12px rgba(0, 99, 170, 0.3);
      font-weight: 600;
    }

    .danger {
      color: #dc2626;
      font-weight: 600;
    }

    .success {
      color: #16a34a;
      font-weight: 600;
    }

    /* Improved output area styling */
    .output-area {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      background-color: #0f172a;
      color: #00e5ff;
      padding: 14px;
      border-radius: var(--radius-sm);
      border: 2px solid #1e293b;
      border-left: 4px solid var(--accent-blue);
      min-height: 240px;
      width: 100%;
      line-height: 1.7;
      font-weight: 400;
      resize: vertical;
      white-space: pre;
    }

    .footer-note {
      font-size: 12px;
      color: #64748b;
      margin-top: 8px;
      line-height: 1.6;
    }

    .inline-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Improved personality slot styling */
    .slot-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .personality-slot {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      background-color: #f8fafc;
      border: 2px solid #cbd5e1;
      border-left: 4px solid var(--accent-blue);
      transition: all 0.2s ease;
    }

    .personality-slot:hover {
      box-shadow: 0 4px 12px rgba(0, 99, 170, 0.1);
      background-color: #f0f7ff;
      border-left-color: var(--sky-main);
    }

    .personality-slot-label {
      font-size: 12px;
      font-weight: 700;
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--sky-light) 0%, rgba(0, 184, 230, 0.1) 100%);
      color: var(--sky-main);
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .personality-slot-text {
      font-size: 13px;
      flex: 1 1 auto;
      min-width: 180px;
      color: var(--machine-dark);
      font-weight: 500;
    }

    /* 태블릿 이하 (폭 768px 이하)용 반응형 */
    @media (max-width: 768px) {
      header {
        padding: 16px 20px;
      }

      header h1 {
        font-size: 20px;
      }

      main {
        margin-top: 24px;
        padding: 0 12px;
      }

      .card {
        padding: 18px 16px;
        margin-bottom: 16px;
      }

      .card h2 {
        font-size: 17px;
      }

      .row {
        gap: 12px;
      }

      .inline-group {
        flex-direction: row;
        align-items: flex-start;
      }

      .inline-group > button {
        flex: 1 1 auto;
      }
    }

    /* 모바일 (폭 480px 이하) 최적화 */
    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      header {
        padding: 14px 16px;
      }

      header h1 {
        font-size: 18px;
      }

      main {
        padding: 0 8px;
        margin-bottom: 24px;
        margin-top: 20px;
      }

      .card {
        padding: 14px 12px;
        margin-bottom: 12px;
      }

      .card h2 {
        font-size: 16px;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }

      input[type="text"],
      textarea,
      select {
        padding: 9px 10px;
        font-size: 14px;
      }

      .row {
        flex-direction: column;
        gap: 8px;
      }

      .col-2 {
        flex: 1 1 100%;
      }

      .inline-group {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .inline-group > button {
        width: 100%;
      }

      button {
        width: 100%;
        justify-content: center;
      }

      .output-area {
        min-height: 200px;
        font-size: 11px;
      }

      .personality-slot {
        flex-direction: column;
        align-items: flex-start;
      }

      .personality-slot button {
        width: 100%;
      }

      .skill-preview {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>톱니바퀴 탑의 탐공사 캐릭터 생성기</h1>
</header>

<main>
  <!-- 기본 정보 -->
  <section class="card">
    <h2>기본 정보</h2>
    <div class="field-group">
      <label for="charName">캐릭터 이름</label>
      <input id="charName" type="text" placeholder="예) 에반">
    </div>
    <div class="field-group">
      <label for="charDescription">캐릭터 설명 / 메모</label>
      <textarea id="charDescription" placeholder="외형, 성격, 배경 등을 자유롭게 적으세요."></textarea>
    </div>
  </section>

  <!-- 종족 및 종족 스킬 -->
  <section class="card">
    <h2>종족 / 종족 스킬</h2>
    <div class="row">
      <div class="col-2">
        <div class="field-group">
          <label for="raceSelect">종족</label>
          <select id="raceSelect">
            <option value="모던 타임즈">모던 타임즈</option>
            <option value="리틀러">리틀러</option>
            <option value="앤티크">앤티크</option>
            <option value="코펠리아">코펠리아</option>
            <option value="퍼리">퍼리</option>
            <option value="플로레스">플로레스</option>
          </select>
          <div class="hint">
            모던 타임즈는 개성 스킬을 3개 습득합니다.
          </div>
        </div>
      </div>
      <div class="col-2">
        <div class="field-group">
          <label for="raceSkillSelect">종족 스킬</label>
          <select id="raceSkillSelect"></select>
          <div class="hint">
            모던 타임즈의 종족 스킬 적응력: 특화 능력을 2개까지 선택 가능.<br>
            모던 타임즈의 종족 스킬 십인십색: 개성 스킬 카드 선택 모드.
          </div>
        </div>
      </div>
    </div>

    <!-- 혼혈용 추가 종족 / 종족 스킬 선택 영역 -->
    <div class="row" id="mixedRaceRow" style="display:none;">
      <div class="col-2">
        <div class="field-group">
          <label for="extraRaceSelect">추가 종족 (혼혈)</label>
          <select id="extraRaceSelect"></select>
          <div class="hint">
            모던 타임즈의 종족 스킬 혼혈을 선택했을 때만 사용합니다. 모던 타임즈 이외의 종족 하나를 선택하세요.
          </div>
        </div>
      </div>
      <div class="col-2">
        <div class="field-group">
          <label for="extraRaceSkillSelect">추가 종족 스킬</label>
          <select id="extraRaceSkillSelect"></select>
          <div class="hint">
            선택한 추가 종족의 종족 스킬 중 하나를 선택합니다.
          </div>
        </div>
      </div>
    </div>

    <!-- 추가 종족 스킬 설명 -->
    <div class="field-group" id="extraRaceSkillDescWrapper" style="display:none;">
      <div class="section-title">추가 종족 스킬 설명 (혼혈)</div>
      <div id="extraRaceSkillDesc" class="skill-preview">
        혼혈로 습득한 추가 종족 스킬의 효과가 여기 표시됩니다.
      </div>
    </div>
    <!-- 혼혈 영역 끝 -->


    <div class="field-group">
      <div class="section-title">종족 특징 설명</div>
      <div id="raceFeatureDesc" class="skill-preview">
        선택한 종족의 기본 특징이 여기 표시됩니다.
      </div>
    </div>

    <div class="field-group">
      <div class="section-title">종족 스킬 설명</div>
      <div id="raceSkillDesc" class="skill-preview">
        선택한 종족 스킬의 효과가 여기 표시됩니다.
      </div>
    </div>
  </section>

  <!-- 능력치 특화/취약 -->
  <section class="card">
    <h2>능력 설정</h2>
    <div class="row">
      <div class="col-2">
        <div class="field-group">
          <label for="specializedAbility">특화 능력 1</label>
          <select id="specializedAbility">
            <option value="기술">기술</option>
            <option value="감각">감각</option>
            <option value="교양">교양</option>
            <option value="신체">신체</option>
          </select>
        </div>
      </div>
      <div class="col-2" id="spec2Wrapper" style="display:none;">
        <div class="field-group">
          <label for="specializedAbility2">추가 특화 능력</label>
          <select id="specializedAbility2">
            <option value="기술">기술</option>
            <option value="감각">감각</option>
            <option value="교양">교양</option>
            <option value="신체">신체</option>
          </select>
          <div class="hint">
            종족 스킬 적응력 또는 개성 스킬 [재능] 천재가 있을 때만 활성화되며, 이 경우 반드시 다른 능력을 특화해야 합니다.
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-2">
        <div class="field-group">
          <label for="weakAbility">취약 능력</label>
          <select id="weakAbility">
            <option value="기술">기술</option>
            <option value="감각">감각</option>
            <option value="교양">교양</option>
            <option value="신체">신체</option>
          </select>
          <div class="hint" id="weakHint">
            기본적으로 취약 능력 1개가 필요합니다. 개성 스킬 [재능] 수재를 얻으면 취약 능력이 아예 사라집니다.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 개성 스킬 -->
  <section class="card">
    <h2>개성 스킬</h2>

    <div class="field-group">
      <span class="section-title">개성 스킬 선택 방식</span>
      <div class="hint">
        기본: 2개, 모던 타임즈는 3개.<br>
        모던 타임즈 + 십인십색이면 카드 선택 모드, 아니라면 2d6 무작위 굴림을 슬롯별로 사용합니다.
      </div>
    </div>

    <div class="field-group">
      <div class="section-title">
        무작위 굴리기 슬롯
        <span class="badge">카드 모드가 아닐 때 사용</span>
      </div>
      <div id="personalitySlotsContainer" class="slot-list"></div>
      <div class="hint">
        슬롯마다 버튼으로 2d6을 굴려 개성 스킬을 정합니다. 이미 정해진 슬롯도 다시 굴릴 수 있습니다.
      </div>
    </div>

    <div class="field-group">
      <div class="section-title">
        현재 선택된 개성 스킬
        <span id="personalityCountInfo" class="badge"></span>
      </div>
      <div id="personalityPreview" class="skill-preview">
        아직 선택된 개성 스킬이 없습니다.
      </div>
    </div>

    <div class="field-group">
      <div class="section-title">
        카드 선택 모드
        <span class="badge">모던 타임즈 + 십인십색일 때 자동 활성화</span>
      </div>
      <div class="hint">
        조건을 만족하면 아래에 36개의 개성 스킬 카드가 표시되며, 직접 클릭해서 선택할 수 있습니다.
      </div>
      <div id="personalityCardsContainer" class="skill-cards-container"></div>
      <div id="cardModeStatus" class="hint"></div>
    </div>
  </section>

  <!-- 마법 스킬 -->
  <section class="card">
    <h2>마법 스킬</h2>
    <div class="field-group">
      <label for="magicSkillSelect">마법 스킬 선택</label>
      <select id="magicSkillSelect">
        <option value="">선택 안 함</option>
      </select>
      <div id="magicHint" class="hint">
        종족이 앤티크이거나 개성 스킬 [경력] 마법사를 가진 경우에만 선택 가능하며, 그때는 1개를 반드시 선택해야 합니다.
      </div>
    </div>

    <div class="field-group">
      <div class="section-title">마법 스킬 설명</div>
      <div id="magicSkillDesc" class="skill-preview">
        선택한 마법 스킬의 효과가 여기 표시됩니다.
      </div>
    </div>
  </section>

  <!-- 탐공사 스킬 -->
  <section class="card">
    <h2>탐공사 스킬</h2>
    <div class="field-group">
      <label for="explorerSkillSelect">탐공사 스킬</label>
      <select id="explorerSkillSelect">
        <option value="회피운동">회피운동</option>
        <option value="탄도학">탄도학</option>
        <option value="비계공">비계공</option>
      </select>
      <div class="hint">
        세 가지 중 하나를 선택합니다.
      </div>
    </div>

    <div class="field-group">
      <div class="section-title">탐공사 스킬 설명</div>
      <div id="explorerSkillDesc" class="skill-preview">
        선택한 탐공사 스킬의 효과가 여기 표시됩니다.
      </div>
    </div>
  </section>

  <!-- 출력 -->
  <section class="card">
    <h2>코코포리아 캐릭터 생성 JSON</h2>
    <p class="hint">
      아래 JSON을 통째로 복사해서 코코포리아 맵 위를 우클릭 후 붙여넣으면 캐릭터가 생성됩니다.
    </p>

    <div class="field-group">
      <div class="inline-group">
        <button type="button" id="generateApiBtn">
          캐릭터 JSON 생성
        </button>
        <button type="button" id="copyApiBtn" class="btn-secondary">
          클립보드로 복사
        </button>
        <span id="copyStatus" class="hint"></span>
      </div>
    </div>

    <div class="field-group">
      <textarea id="apiOutput" class="output-area" spellcheck="false" placeholder='먼저 "캐릭터 JSON 생성" 버튼을 눌러 주세요.'></textarea>
    </div>

    <div class="footer-note">
      status: 생명점 10/10(기본, 각종 보정 후 자동 조정), 유대 0/6, BS 0/5, 이동력 3/0(기본 3, 각종 보정 후 자동 조정)<br>
      params: 네 능력(기술/감각/교양/신체)을 value "0"/"1"/"2" (문자열)로 저장<br>
      memo: 이름 + 설명 + 종족 + 능력 + 기본 유대/배드 스테이터스 틀 자동 포함
    </div>
  </section>
</main>

<script>
  // ------------------------------
  // 데이터 정의 (설명 텍스트 포함)
  // ------------------------------

  var personalityCategories = [
    "재능",
    "습관",
    "특기",
    "소지",
    "성격",
    "경력"
  ];

  var personalitySkills = {
    "재능": [
      "수재",
      "천재",
      "전문 분야",
      "직인 기질",
      "곡예",
      "강건함"
    ],
    "습관": [
      "신앙",
      "한 가지 재주",
      "선호 대상",
      "단련",
      "불야성",
      "땡땡이 상습범"
    ],
    "특기": [
      "제육감",
      "아크로바트",
      "허세",
      "천리안",
      "용의주도",
      "발상의 전환"
    ],
    "소지": [
      "명장의 공구상자",
      "황금 나침반",
      "고품질 공로드",
      "아키츠 도검",
      "실버 불릿",
      "앞주머니의 동전"
    ],
    "성격": [
      "치유의 성원",
      "친화력",
      "사랑스러움",
      "외로움쟁이",
      "독설",
      "카리스마"
    ],
    "경력": [
      "빈민 출신",
      "금수저",
      "커넥션",
      "평범",
      "베테랑",
      "마법사"
    ]
  };

  // 개성 스킬 설명
  var personalitySkillDescriptions = {
    "재능": {
      "수재": "당신이 [취약]한 [능력] 1개를 선택해 [취약]이 아닌 보통 능력으로 바꾸는 재능입니다. 모조 등의 효과로 이 스킬이 미습 상태가 되면, 다시 그 능력이 [취약]으로 되돌아갑니다.",
      "천재": "아직 [특화]도 [취약]도 아닌 [능력] 1개를 선택해 [특화]로 바꾸는 재능입니다. 이 효과로 인해 그 캐릭터가 [특화]한 [능력]을 3개 이상 가지게 될 수는 없습니다.",
      "전문 분야": "행동 판정에 요구되는 두 능력이 모두 당신의 [특화] 능력일 때, 그 판정의 [판정 주사위]가 4개가 됩니다. 이 생성기에서는 해당 상황의 판정을 4SN으로 처리합니다.",
      "직인 기질": "취약한 분야에서도 장인처럼 버티는 기질입니다. 행동 판정에 [취약] 능력이 포함되어 [취약한 판정(SN2)]이 될 상황이라도, 이 스킬로 그것을 [특화한 판정(3SN)]으로 간주해 처리할 수 있습니다.",
      "곡예": "몸을 자유자재로 구사하는 재능입니다. 당신의 [이동력]이 1칸 증가합니다.",
      "강건함": "튼튼한 체력과 지구력을 가진 체질입니다. 당신의 [생명점]과 [생명점 최대치]가 2점 증가합니다."
    },
    "습관": {
      "신앙": "타이밍: 당신의 장면 / 사용횟수: 제한 없음\n액션으로 [기도]를 선언합니다. 자신이 가진 [특화] 능력 1개를 보통으로 되돌리고, 대신 아직 [특화]도 [취약]도 아닌 [능력] 1개를 [특화]로 바꿉니다. 신앙의 방향을 바꾸며 능력 배치를 재조정하는 습관입니다.",
      "한 가지 재주": "타이밍: 당신의 장면 / 사용횟수: 세션당 3회\n액션으로 [장기자랑]을 선언합니다. 같은 파트에 있는 모든 캐릭터가 각각 [1D6점]의 [생명점]을 회복합니다. 몸에 밴 특기 하나로 분위기를 살리며 모두를 회복시키는 습관입니다.",
      "선호 대상": "타이밍: 당신의 장면 / 사용횟수: 세션당 2회\n액션으로 [취미]를 선언해, 자신에 대한 [우대] 1개를 획득합니다. 특정 물건·사람·분야를 너무 좋아해서, 그와 관련된 일에는 더 잘해내는 성향을 나타냅니다.",
      "단련": "타이밍: 당신의 장면 / 사용횟수: 세션당 3회\n액션으로 [단련]을 선언합니다. 그 세션 동안 당신의 [생명점]과 [생명점 최대치]가 2점 증가하며, 이 효과는 최대 3회까지 누적됩니다. 꾸준한 트레이닝으로 점점 더 단단해지는 습관입니다.",
      "불야성": "타이밍: 플레이어 페이즈 / 사용횟수: 세션당 1회\n모든 플레이어가 [행동 완료]가 되었을 때 사용하여, 추가로 당신을 장면 플레이어로 하는 장면을 1개 더 개시합니다. 밤이 되면 더 깨어나는 생활 리듬을 표현합니다.",
      "땡땡이 상습범": "타이밍: 항상 / 사용횟수: 제한 없음\n당신은 퀘스트 페이즈에서도 플라이트 페이즈와 마찬가지로 액션으로 [휴식]을 선언할 수 있습니다. 본분은 제쳐두고 틈만 나면 쉬어 버리는 버릇입니다."
    },
    "특기": {
      "제육감": "타이밍: 당신이 행동 판정을 할 때 / 사용횟수: 세션당 1회\n해당 행동 판정에서 주사위를 모두 굴린 직후 사용합니다. 그 판정의 주사위 전부를 다시 굴릴 수 있습니다. 뭔가 이상하다고 느끼면 곧장 다시 시도하는 예민한 감각입니다.",
      "아크로바트": "타이밍: 항상 / 사용횟수: 제한 없음\n무브로 이동할 때, 다른 캐릭터가 있는 칸이라도 통과할 수 있습니다. 좁은 통로나 난간 위를 재빠르게 뛰어넘는 곡예 감각을 나타냅니다.",
      "허세": "타이밍: 퀘스트 페이즈 / 사용횟수: 세션당 1회\n해당 페이즈에 등장한 임의의 캐릭터 1명을 선택해 즉시 [넘어진] 상태로 만듭니다. 실속은 없을지라도, 허세와 기세로 상대를 움찔하게 만드는 재주입니다.",
      "천리안": "타이밍: 당신의 장면 / 사용횟수: 제한 없음\n이 장면 동안, 당신이 있는 파트는 [정찰] 키워드를 가진 것으로 간주합니다. 먼 곳이나 미묘한 변화를 잘 포착하는 시야를 나타냅니다.",
      "용의주도": "타이밍: 퀘스트 페이즈 개시 시 / 사용횟수: 제한 없음\n같은 선내의 캐릭터 둘을 골라, 그 라운드에 담당할 일을 서로 바꾸거나 재배치할 수 있습니다. 미리 짜 둔 계획대로 사람 배치를 갈아 끼우는 치밀함을 표현합니다.",
      "발상의 전환": "타이밍: 누군가가 행동 판정을 할 때 / 사용횟수: 세션당 2회\n누군가가 행동 판정의 주사위를 굴린 직후 사용합니다. 그 판정에 사용되는 [능력]을 [기술/감각/교양/신체] 중 다른 하나로 변경합니다. 고정관념을 깨고 전혀 다른 관점에서 문제를 해결하는 재주입니다."
    },
    "소지": {
      "명장의 공구상자": "타이밍: 당신이 [수리] 액션을 할 때\n해당 수리 액션으로 [수복 불능] 칸을 최대 2칸까지 제거할 수 있습니다. 명장의 손때가 밴 고급 공구 세트로, 웬만한 손상은 깔끔하게 되살려 냅니다.",
      "황금 나침반": "타이밍: 항행 체크 후 / 사용횟수: 제한 없음\n항행 체크에서 주사위를 굴린 뒤, 그 눈을 1만큼 늘리거나 줄일 수 있습니다. 언제나 최적의 코스를 찾아 주는 믿음직한 나침반입니다.",
      "고품질 공로드": "타이밍: 플레이어 페이즈 장면과 장면 사이 / 사용횟수: 세션당 2회\n비공정 맵의 플레이어 에어리어에 있는 이벤트 스폿 1곳을 선택해, 그 스폿의 이벤트 타입을 다른 타입 하나로 바꿀 수 있습니다. 고급 설계용 공로드 덕분에 배의 구조를 유리하게 손보는 느낌입니다.",
      "아키츠 도검": "타이밍: 특수 전투(택별전) 관련 / 사용횟수: 제한 없음\n당신이 『택별전』의 액션을 했거나 그 대상이 되었고, 택별 판정에 승리했을 때, 패배한 캐릭터의 [생명점] 감소분이 [2D6]이 됩니다(룰북 p89 참조). 승부를 갈라 버리는 날카로운 일도검입니다.",
      "실버 불릿": "타이밍: 당신의 턴, [포격] 액션 직전 / 사용횟수: 세션당 1회\n이번 [포격]으로 상대 비공정에 발생하는 대미지를 [D/1]로 변경하고, 그 대미지를 적용할 때 당신이 지정한 칸을 대미지 칸으로 삼을 수 있습니다. 반드시 맞히고 싶은 한 방을 위해 아껴 두는 특수 탄입니다.",
      "앞주머니의 동전": "타이밍: 당신의 [생명점]이 감소하는 효과를 받을 때 / 사용횟수: 세션당 1회\n해당 [생명점] 감소를 완전히 무효로 합니다. 주머니 속에 넣어 둔 동전 하나가, 기묘하게도 최악의 순간을 비켜가게 해 주는 행운의 부적 같은 존재입니다."
    },
    "성격": {
      "치유의 성원": "타이밍: 언제든지 / 사용횟수: 제한 없음\n당신이 누군가에 대한 [유대]의 [지원 체크]에 성공했을 때, 그 캐릭터는 추가로 [1D6점]의 [생명점]을 회복합니다. 말 한마디·응원 한 번으로도 동료를 회복시키는 따뜻한 성격입니다.",
      "친화력": "타이밍: 언제든지 / 사용횟수: 세션당 1회\n임의의 캐릭터 1명에 대한 [유대]를 즉시 획득합니다. 누구와도 금세 친해지는 인간적인 매력입니다.",
      "사랑스러움": "타이밍: 언제든지 / 사용횟수: 세션당 3회\n같은 페이즈에 등장한 캐릭터가 당신에 대한 [유대]를 획득했을 때 사용할 수 있습니다. 그 캐릭터에 대한 [유대]를 당신도 함께 획득합니다. 보는 이의 마음을 사로잡는 사랑스러운 기질입니다.",
      "외로움쟁이": "타이밍: 상시 / 사용횟수: 제한 없음\n당신이 [유대]를 가진 캐릭터가 같은 파트에 있을 때, 그 장면 동안 당신이 시도하는 모든 행동 판정은 지정된 [능력]과 관계없이 [특화한 판정]이 됩니다. 혼자서는 못 살아도, 누군가 곁에 있으면 누구보다 강해지는 타입입니다.",
      "독설": "타이밍: 누군가가 행동 판정을 할 때 / 사용횟수: 세션당 2회\n그 행동 판정에서 주사위를 굴린 직후, 주사위 눈 1개를 [1]로 바꿀 수 있습니다. 정곡을 찌르는 한마디로 상대의 흐름을 망가뜨리는 독한 입담입니다.",
      "카리스마": "타이밍: 퀘스트 페이즈 / 사용횟수: 세션당 1회\n당신이 [행동 완료]가 될 때 사용해, 같은 파트의 다른 PC 1명을 선택합니다. 그 캐릭터의 [행동 완료]를 해제하거나, 아직 행동하지 않았다면 그 캐릭터가 곧바로 행동하게 만들 수 있습니다. 자연스럽게 모두의 시선을 모으는 리더십입니다."
    },
    "경력": {
      "빈민 출신": "가난한 환경에서 살아남으며 단련된 경력입니다. 이 생성기에서는 [휴식] 액션을 할 때 회복하는 [생명점]이 기본값보다 3점 더 많다고 취급합니다.",
      "금수저": "부유한 집안 출신으로, 비공정 설계나 자금 조달에 강점을 가집니다. 룰 상으로는 비공정 설계 시 비공정 설계 키워드의 보너스를 받으며, 이 생성기에서는 비공정 관련 판정을 유리하게 서술할 때 사용하는 배경으로 취급합니다.",
      "커넥션": "타이밍: 당신이 행동 판정을 할 때 / 사용횟수: 세션당 1회\n판정 주사위를 굴린 직후 사용해, 그 행동 판정에 대해 [판정 지원] 1회를 적용한 것과 같은 효과를 얻되, [유대]의 [지원 체크]는 발생하지 않습니다. 각지에 퍼진 인맥 덕분에 어떻게든 도움을 받아내는 경력입니다.",
      "평범": "타이밍: 당신이 행동 판정을 할 때 / 사용횟수: 제한 없음\n그 행동 판정의 [펌블치]가 1이라면, 그 판정에서는 [펌블]이 발생하지 않습니다. 너무 평범해서인지, 기묘하게도 최악의 사고만은 비켜가는 타입입니다.",
      "베테랑": "타이밍: 당신이 행동 판정에서 펌블을 냈을 때 / 사용횟수: 세션당 1회\n그 행동 판정에서 [펌블]이 발생했을 때 사용해, 그 [펌블]을 무효로 하고 단순 실패로 바꿉니다. 경험 많은 현장 베테랑답게, 치명적인 실수는 어떻게든 수습해 버립니다.",
      "마법사": "마법에 대한 훈련을 받은 경력입니다. 캐릭터 제작 시 p420에 기재된 [마법 스킬] 중 1개를 추가로 습득할 수 있는 자격을 얻습니다."
    }
  };

  // 종족 특성/스킬 설명
  var raceFeatureDescriptions = {
    "리틀러": "종족 특성: 작은 몸집\n- 이동력이 1점 증가합니다.\n- 좁고 복잡한 선내에서도 재빠르게 움직이는, 소형 종족 특유의 민첩성을 나타냅니다.",
    "모던 타임즈": "종족 특성: 호기심\n- 기본적으로 개성 스킬을 많이 습득해 자신을 세밀하게 커스터마이징할 수 있는 인간 계열 종족입니다.\n- 다양한 빌드가 가능합니다.",
    "앤티크": "종족 특성: 고대종\n- 마법 스킬 1개를 선택하여 습득합니다.\n- 오래된 혈통과 이능을 이어받아, 강력하지만 취급을 잘못하면 위험한 마법을 다루는 이미지를 줍니다.",
    "코펠리아": "종족 특성: 정원 외\n- 정원 외에 관한 처리(탑승 인원수, 좌석 수 등)를 셀 때 머릿수에 포함되지 않습니다.\n- 작업, 변형, 특수 구조를 활용하는 플레이에 특화된 인형형 종족입니다.",
    "퍼리": "종족 특성: 짐승의 모습\n- [생명점]과 그 최대치가 3점 증가합니다.\n- 기본적으로 사람보다 튼튼한 체구를 가진 전투·기동 특화 종족입니다.",
    "플로레스": "종족 특성: 행운의 요정\n- 세션 개시 시, 자신 이외의 PC 1명에 대한 [유대]를 미리 1개 획득합니다.\n- 파티의 유대와 회복, 지원 역할을 맡기 좋은, 작은 행운을 데려오는 종족입니다."
  };

  var raceSkillDescriptions = {
    "리틀러": {
      "데꺽데꺽": "타이밍: 턴 종료 시 / 사용횟수: 세션당 1회\n자신의 턴이 끝난 직후 즉시 추가 턴을 1회 얻습니다. 이 추가 턴에서는 일반적인 턴과 마찬가지로 무브와 액션을 할 수 있지만, 파츠 효과를 사용하는 액션은 선언할 수 없습니다.",
      "일곱 도구": "타이밍: 당신이 행동 판정을 할 때 / 사용횟수: 세션당 3회\n해당 행동 판정이 [특화한 판정]일 경우, 주사위를 굴리지 않고 자동 성공으로 처리할 수 있습니다(대행 판정에는 사용 불가). 리틀러 특유의 손재주와 공구 활용 능력을 나타냅니다.",
      "고소 작업의 명수": "타이밍: 캐릭터 제작 / 사용횟수: 항상\n당신의 [이동력]이 1점 증가합니다. 높은 곳이나 위험한 발판 위를 오르내리는 데 능숙한 비계공 경력을 가진 리틀러를 표현합니다."
    },
    "모던 타임즈": {
      "적응력": "타이밍: 캐릭터 제작 / 사용횟수: 제한 없음\n아직 [특화]도 [취약]도 아닌 [능력] 1개를 선택해 [특화]로 바꿉니다. 이 효과로 [특화]한 [능력]이 3개 이상이 되도록 만들 수는 없습니다. 현대 사회에 익숙한 유연한 적응력을 보여 줍니다.",
      "혼혈": "타이밍: 캐릭터 제작 / 사용횟수: 제한 없음\n모던 타임즈 이외의 종족을 하나 선택하고, 그 종족의 종족 스킬 1개를 임의로 골라 습득합니다. 대신 이 스킬을 습득한 순간, 당신의 [생명점]과 [생명점 최대치]가 2점 감소합니다. 여러 혈통이 뒤섞인 배경을 표현합니다.",
      "십인십색": "타이밍: 캐릭터 제작 / 사용횟수: 제한 없음\n당신은 개성 스킬을 습득할 때, 무작위가 아니라 원하는 개성 스킬을 직접 선택해 습득할 수 있습니다. 단, 같은 이름의 개성 스킬을 2개 이상 중복해서 얻을 수는 없습니다. 각양각색의 인간 군상을 나타내는 스킬입니다."
    },
    "앤티크": {
      "흡혈귀": "타이밍: 효과 참조 / 사용횟수: 제한 없음\n같은 파츠 내의 동의한 캐릭터 1명을 대상으로 [흡혈]을 선언할 수 있습니다. 대상의 [생명점]을 0 아래로 내려가지 않는 한도에서 감소시키고, 그 감소한 수치만큼 자신의 [흡혈점]을 얻습니다. 이후 마법 스킬을 사용할 때는 [생명점] 대신 이 [흡혈점]을 소모해 [마법 코스트]를 지불할 수 있습니다.",
      "공포": "타이밍: 효과 참조 / 사용횟수: 제한 없음\n이 책에 기재된 모든 마법 스킬을 사용할 자격을 얻습니다. 다만 이 스킬의 효과로 습득하지 않은 마법 스킬을 사용할 때마다, 자신이 가진 [유대] 중 하나에 [지원 체크]를 표시해야 합니다. 초자연적인 기술을 두려워하는 타 종족의 시선을 반영한 스킬입니다.",
      "마법 아이템": "타이밍: 언제든지 / 사용횟수: 세션당 1회\n이 스킬을 습득할 때, 임의의 마법 스킬 1개를 선택해 캐릭터 시트의 종족 스킬 항목에 「마법 아이템: ○○」 형식으로 기입합니다. 당신은 그 마법 스킬을 즉시 습득하고, [마법 코스트]를 지불하지 않고 1회 즉시 사용할 수 있습니다. 사용 후 그 마법 스킬은 항상 미습 상태로 남습니다. 애지중지하는 비밀 도구를 표현합니다."
    },
    "코펠리아": {
      "작업 기계": "타이밍: 당신의 턴 개시 시 / 사용횟수: 세션당 1회\n그 턴에는 무브를 하는 대신 액션을 2회 할 수 있습니다. 같은 파츠 효과를 2번 사용하는 것도 가능합니다. 반복 작업에 특화된 기계 인형의 성능을 나타냅니다.",
      "예술품": "타이밍: 상시 / 사용횟수: 제한 없음\n퀘스트 페이즈에서도 플라이트 페이즈와 마찬가지로 액션으로 [교류]를 선언할 수 있습니다(효과는 룰북 p89의 [교류] 참조). 뛰어난 외형과 완성도로 사람들을 끌어당기는, 예술 작품 같은 코펠리아를 표현합니다.",
      "다기능형": "타이밍: 당신의 턴 / 사용횟수: 세션당 1회\n액션으로 [변형]을 선언합니다. 선언했다면 자신이 장비한 파츠 중 하나를 선택해, 룰에 따라 공격력·카테고리·기타 효과를 다른 파츠처럼 바꿀 수 있습니다. 라운드 동안 상황에 맞게 몸을 개조해 쓰는 다기능 인형입니다."
    },
    "퍼리": {
      "비행 능력": "타이밍: 상시 / 사용횟수: 제한 없음\n무브로 이동할 때, 특정 파츠의 바닥 칸이 아닌 칸이나 파츠 사이 빈 공간이라도 [낙하]하지 않고 이동할 수 있습니다. 필요하다면 일반적인 이동 규정을 무시하고 공중을 경유해 이동하는 것으로 간주합니다. 선내에서 몸을 날리는 비행 감각을 표현합니다.",
      "매혹적인 모피": "타이밍: 퀘스트 페이즈 / 사용횟수: 제한 없음\n각 라운드 종료 시, 당신이 있는 파트 내의 자신 이외의 캐릭터 1명을 선택해 그 캐릭터의 [생명점]을 [1점] 회복시킬 수 있습니다. 폭신폭신한 모피와 친근한 분위기로 주변의 피로를 풀어 주는 스킬입니다.",
      "도약": "타이밍: 언제든지 / 사용횟수: 세션당 1회\n즉시 무브 처리를 1회 합니다. 이 스킬은 어떤 효과 중간에도 끼어 사용할 수 있으며, 이 도약으로 인해 당신을 대상으로 하던 효과의 유효 범위를 벗어나게 되면 그 효과는 무효가 됩니다. 짧은 순간에 폭발적인 발을 내딛는 스킬입니다."
    },
    "플로레스": {
      "작은 행운": "타이밍: 누군가가 행동 판정을 할 때 / 사용횟수: 세션당 3회\n당신이 판정 지원을 할 때, 대상이 되는 행동 판정에서 굴린 주사위 하나의 눈을 1 더 높은 눈으로 변경하는 대신, 6으로 변경할 수 있습니다. 사소한 우연이 결과를 살짝 비틀어 주는 느낌의 스킬입니다.",
      "취록의 향기": "타이밍: 상시 / 사용횟수: 제한 없음\n당신에 대한 [유대]를 가진 캐릭터는, 당신의 효과에 의해 [1D6점]의 [생명점]을 회복할 수 있습니다. 몸에서 나는 향기나 분위기가 주변 사람들의 긴장을 풀고 치유하는 느낌을 줍니다.",
      "조언자": "타이밍: 언제든지 / 사용횟수: 세션당 1회\n즉시 자신이 보유한 모든 [유대]의 [지원 체크]에 붙어 있는 체크를 전부 제거합니다. 이후 다시 그 유대들을 판정 지원에 자유롭게 사용할 수 있게 되어, 파티 전체의 지원력을 크게 끌어올립니다."
    }
  };

  // 종족 스킬 매핑
  var raceSkillMap = {
    "모던 타임즈": ["적응력", "혼혈", "십인십색"],
    "리틀러": ["데꺽데꺽", "일곱 도구", "고소 작업의 명수"],
    "앤티크": ["흡혈귀", "공포", "마법 아이템"],
    "코펠리아": ["작업 기계", "예술품", "다기능형"],
    "퍼리": ["비행 능력", "매혹적인 모피", "도약"],
    "플로레스": ["작은 행운", "취록의 향기", "조언자"]
  };

  // 마법 스킬 목록
  var magicSkills = [
    "텔레포트",
    "클레어보이언스",
    "텔레키네시스",
    "파이로키네시스",
    "레비테이션",
    "텔레파시"
  ];

  // commands용 스킬 한 줄 설명
  var explorerSkillCommands = {
    "회피운동": "《회피운동》 타이밍: [대미지 체크] 후(조타계, 중파 아님) | 효과: 감각/교양:7 회피 판정에 성공하면 이번에 결정된 모든 대미지 칸을 지정한 방향으로 1칸씩 옮겨서 적용한다 | 횟수: 같은 [대미지 체크] 타이밍에 1회",
    "탄도학":   "《탄도학》 타이밍: 당신의 턴, [포격] 선언 직전 | 효과: 상하좌우 중 한 방향을 고른다. 대미지 칸들을 그 방향으로 1칸씩 옮겨서 적용한다 | 횟수: 제한 없음",
    "비계공":   "《비계공》 타이밍: 항상 | 효과: 이동력+1, 파손된 칸에서 무브에 의한 이동을 종료하지 않아도 되며, 파손된 칸을 통과해서 이동할 수 있다 | 횟수: 상시 효과"
  };

  var raceSkillCommands = {
    "리틀러": {
      "데꺽데꺽": "《데꺽데꺽》 타이밍: 당신의 턴 종료 시 | 효과: 턴 종료 직후 즉시 자신의 추가 턴 1회 획득(이 추가 턴에서는 파츠 효과 사용 불가) | 횟수: 세션당 1회",
      "일곱 도구": "《일곱 도구》 타이밍: 당신이 행동 판정을 할 때 | 효과: 해당 판정이 특화 판정일 경우 주사위를 굴리지 않고 자동 성공 처리(대행 판정에는 불가) | 횟수: 세션당 3회",
      "고소 작업의 명수": "《고소 작업의 명수》 타이밍: 항상 | 효과: 이동력+1, 높은 곳/위험한 발판을 오르내리는 서술에 유리 | 횟수: 상시 효과"
    },
    "모던 타임즈": {
      "적응력": "《적응력》 타이밍: 캐릭터 제작 시 | 효과: 아직 특화/취약이 아닌 능력 1개를 특화로 변경(특화 능력 총 3개 이상은 불가) | 횟수: 설정 시 1회",
      "혼혈":   "《혼혈》 타이밍: 캐릭터 제작 시 | 효과: 모던 타임즈 이외의 종족 1개를 골라 그 종족 스킬 1개를 추가 습득, 대신 생명점/최대 생명점 -2 | 횟수: 설정 시 1회",
      "십인십색": "《십인십색》 타이밍: 캐릭터 제작 시 | 효과: 개성 스킬을 무작위가 아니라 36개 중에서 직접 선택(같은 이름의 개성 스킬 중복 불가) | 횟수: 설정 시 1회"
    },
    "앤티크": {
      "흡혈귀": "《흡혈귀》 타이밍: 언제든지(효과 선언 시) | 효과: 같은 파츠의 동의한 캐릭터 1명을 대상으로 흡혈, 그 생명점 감소분만큼 자신의 흡혈점을 얻어 이후 마법 코스트 지불에 사용 | 횟수: 흡혈점이 허용하는 한 반복 가능",
      "공포":   "《공포》 타이밍: 마법 사용 선언 시 | 효과: 룰북에 기재된 모든 마법 스킬 사용 자격 획득, 이 스킬로 습득하지 않은 마법 사용 시마다 자신의 유대 1개에 지원 체크 부여 | 횟수: 제한 없음(유대가 허용하는 범위)",
      "마법 아이템": "《마법 아이템》 타이밍: 캐릭터 제작/세션 중 1회 | 효과: 임의의 마법 스킬 1개를 마법 아이템으로 등록하고 코스트 없이 1회 즉시 사용, 이후 해당 마법은 항상 미습 상태로 남음 | 횟수: 세션당 1회"
    },
    "코펠리아": {
      "작업 기계": "《작업 기계》 타이밍: 자신의 턴 개시 시 | 효과: 그 턴에는 무브를 포기하는 대신 액션을 2회 수행(같은 파츠 효과 2회 사용 가능) | 횟수: 세션당 1회",
      "예술품":   "《예술품》 타이밍: 항상 | 효과: 퀘스트 페이즈에서도 플라이트 페이즈와 같이 액션으로 [교류] 선언 가능 | 횟수: 상시 효과",
      "다기능형": "《다기능형》 타이밍: 당신의 턴 | 효과: 액션으로 [변형] 선언, 자신이 장비한 파츠 1개의 공격력·카테고리 등을 다른 파츠처럼 일시적으로 변경 | 횟수: 세션당 1회"
    },
    "퍼리": {
      "비행 능력": "《비행 능력》 타이밍: 항상 | 효과: 무브 시 바닥이 없는 칸이나 파츠 사이 빈 공간을 이동해도 낙하하지 않음, 공중 경로 이동이 가능 | 횟수: 상시 효과",
      "매혹적인 모피": "《매혹적인 모피》 타이밍: 퀘스트 페이즈, 라운드 종료 시 | 효과: 같은 파츠의 자신 이외 캐릭터 1명의 생명점 1점 회복 | 횟수: 라운드마다 1회",
      "도약": "《도약》 타이밍: 언제든지 | 효과: 즉시 무브 1회 처리, 이 이동으로 효과 범위를 벗어나면 자신을 대상으로 하던 효과 1개를 무효화 | 횟수: 세션당 1회"
    },
    "플로레스": {
      "작은 행운": "《작은 행운》 타이밍: 누군가가 행동 판정을 할 때 | 효과: 판정 지원으로 눈을 1 높이는 대신 6으로 변경 | 횟수: 세션당 3회",
      "취록의 향기": "《취록의 향기》 타이밍: 항상 | 효과: 당신에 대한 유대를 가진 캐릭터는, 당신 효과로 1D6 생명점 회복 가능 | 횟수: 상시 효과",
      "조언자": "《조언자》 타이밍: 언제든지 | 효과: 자신이 가진 모든 유대의 지원 체크를 전부 제거하여 다시 사용 가능하게 만듦 | 횟수: 세션당 1회"
    }
  };

  var personalitySkillCommands = {
    "재능": {
      "수재": "《수재》 타이밍: 캐릭터 제작/설정 변경 시 | 효과: 취약인 능력 1개를 보통으로 변경, 그 능력의 취약 제거(결과적으로 이 캐릭터는 취약 능력이 없음) | 횟수: 설정 시 1회",
      "천재": "《천재》 타이밍: 캐릭터 제작/설정 변경 시 | 효과: 아직 특화/취약이 아닌 능력 1개를 특화로 변경(특화 능력 총 3개 이상은 불가) | 횟수: 설정 시 1회",
      "전문 분야": "《전문 분야》 타이밍: 행동 판정 시 | 효과: 판정에 요구되는 능력 둘 다가 자신의 특화일 경우 판정 주사위 4개 사용(4SN) | 횟수: 제한 없음",
      "직인 기질": "《직인 기질》 타이밍: 행동 판정 시 | 효과: 요구 능력 중 하나가 특화, 하나가 취약인 판정을 3SN으로 처리(취약 페널티를 상쇄) | 횟수: 제한 없음",
      "곡예": "《곡예》 타이밍: 항상 | 효과: 이동력+1, 곡예적인 이동 서술에 유리 | 횟수: 상시 효과",
      "강건함": "《강건함》 타이밍: 항상 | 효과: 생명점 및 최대 생명점+2 | 횟수: 상시 효과"
    },
    "습관": {
      "신앙": "《신앙》 타이밍: 당신의 장면 | 효과: 액션으로 [기도] 선언, 특화 능력 1개를 보통으로 되돌리고 다른 보통 능력 1개를 특화로 변경 | 횟수: 제한 없음",
      "한 가지 재주": "《한 가지 재주》 타이밍: 당신의 장면 | 효과: 액션으로 [장기자랑] 선언, 같은 파트에 있는 모든 캐릭터의 생명점 1D6 회복 | 횟수: 세션당 3회",
      "선호 대상": "《선호 대상》 타이밍: 당신의 장면 | 효과: 액션으로 [취미] 선언, 자신에 대한 우대 1개 획득 | 횟수: 세션당 2회",
      "단련": "《단련》 타이밍: 당신의 장면 | 효과: 그 세션 동안 생명점 및 최대 생명점+2(최대 3회 누적) | 횟수: 세션당 3회",
      "불야성": "《불야성》 타이밍: 플레이어 페이즈, 모든 PC가 행동 완료가 되었을 때 | 효과: 자신을 장면 플레이어로 하는 장면을 1개 더 개시 | 횟수: 세션당 1회",
      "땡땡이 상습범": "《땡땡이 상습범》 타이밍: 항상 | 효과: 퀘스트 페이즈에서도 액션으로 [휴식] 선언 가능 | 횟수: 상시 효과"
    },
    "특기": {
      "제육감": "《제육감》 타이밍: 당신이 행동 판정을 할 때 | 효과: 판정 주사위를 모두 굴린 직후, 그 판정의 주사위 전부를 다시 굴릴 수 있음 | 횟수: 세션당 1회",
      "아크로바트": "《아크로바트》 타이밍: 항상 | 효과: 무브 시 다른 캐릭터가 있는 칸도 통과 가능 | 횟수: 상시 효과",
      "허세": "《허세》 타이밍: 퀘스트 페이즈 | 효과: 등장한 임의의 캐릭터 1명을 즉시 [넘어진] 상태로 만듦 | 횟수: 세션당 1회",
      "천리안": "《천리안》 타이밍: 당신의 장면 개시 시 | 효과: 이 장면 동안 당신이 있는 파트는 [정찰] 키워드를 가진 것으로 취급 | 횟수: 장면마다 1회 선언 가능",
      "용의주도": "《용의주도》 타이밍: 퀘스트 페이즈 개시 시 | 효과: 같은 선내의 캐릭터 둘을 골라, 그 라운드에 담당할 일을 서로 교체하거나 재배치 | 횟수: 제한 없음",
      "발상의 전환": "《발상의 전환》 타이밍: 누군가가 행동 판정을 할 때 | 효과: 주사위를 굴린 직후, 그 판정에 사용되는 능력을 다른 능력 1개로 변경 | 횟수: 세션당 2회"
    },
    "소지": {
      "명장의 공구상자": "《명장의 공구상자》 타이밍: 당신이 [수리] 액션을 할 때 | 효과: 해당 수리로 수복 불능 칸을 최대 2칸까지 제거 가능 | 횟수: 제한 없음",
      "황금 나침반": "《황금 나침반》 타이밍: 항행 체크 후 | 효과: 굴린 항행 주사위 결과를 1만큼 높이거나 낮출 수 있음 | 횟수: 제한 없음",
      "고품질 공로드": "《고품질 공로드》 타이밍: 플레이어 페이즈, 장면과 장면 사이 | 효과: 비공정 맵의 플레이어 에어리어에 있는 이벤트 스폿 1곳의 이벤트 타입을 다른 타입 1개로 변경 | 횟수: 세션당 2회",
      "아키츠 도검": "《아키츠 도검》 타이밍: 택별전 관련 판정 시 | 효과: 자신이 택별전 액션의 승자가 되었을 때, 패배한 쪽의 생명점 감소를 2D6으로 처리 | 횟수: 제한 없음",
      "실버 불릿": "《실버 불릿》 타이밍: 당신의 턴, [포격] 선언 직전 | 효과: 이번 포격의 대미지를 D/1로 변경하고, 대미지 칸을 자신이 지정한 칸에 강제로 적용 | 횟수: 세션당 1회",
      "앞주머니의 동전": "《앞주머니의 동전》 타이밍: 당신의 생명점이 감소하는 효과를 받을 때 | 효과: 해당 생명점 감소를 완전히 무효화 | 횟수: 세션당 1회"
    },
    "성격": {
      "치유의 성원": "《치유의 성원》 타이밍: 언제든지 | 효과: 자신이 누군가에 대한 유대의 지원 체크에 성공했을 때, 그 캐릭터의 생명점 추가 1D6 회복 | 횟수: 제한 없음",
      "친화력": "《친화력》 타이밍: 언제든지 | 효과: 임의의 캐릭터 1명에 대한 유대를 즉시 1개 획득 | 횟수: 세션당 1회",
      "사랑스러움": "《사랑스러움》 타이밍: 언제든지 | 효과: 같은 페이즈에 등장한 캐릭터가 당신에 대한 유대를 획득했을 때, 그 캐릭터에 대한 유대를 자신도 1개 획득 | 횟수: 세션당 3회",
      "외로움쟁이": "《외로움쟁이》 타이밍: 상시 | 효과: 자신이 유대를 가진 캐릭터가 같은 파트에 있을 때, 그 장면 동안 자신의 모든 행동 판정을 특화 판정으로 취급 | 횟수: 상시 효과",
      "독설": "《독설》 타이밍: 누군가가 행동 판정을 할 때 | 효과: 굴린 주사위 중 1개의 눈을 1로 변경 | 횟수: 세션당 2회",
      "카리스마": "《카리스마》 타이밍: 퀘스트 페이즈, 당신이 행동 완료가 될 때 | 효과: 같은 파트의 다른 PC 1명의 행동 완료를 해제하거나, 아직 행동 전이라면 곧바로 행동하게 함 | 횟수: 세션당 1회"
    },
    "경력": {
      "빈민 출신": "《빈민 출신》 타이밍: [휴식] 액션 시 | 효과: 휴식으로 회복하는 생명점이 기본보다 3점 많다고 취급 | 횟수: 제한 없음",
      "금수저": "《금수저》 타이밍: 비공정 설계/자금 관련 처리 시 | 효과: 비공정 설계나 자금 조달 관련 판정/서술에서 유리한 배경으로 사용 | 횟수: 상시 효과(서술용)",
      "커넥션": "《커넥션》 타이밍: 당신이 행동 판정을 할 때 | 효과: 판정 주사위를 굴린 직후, 유대를 소모하지 않고 판정 지원 1회를 받은 것과 같은 보너스를 획득 | 횟수: 세션당 1회",
      "평범": "《평범》 타이밍: 당신이 행동 판정을 할 때 | 효과: 그 판정의 펌블치가 1이라면, 어떤 눈이 나와도 펌블이 발생하지 않음 | 횟수: 제한 없음",
      "베테랑": "《베테랑》 타이밍: 당신이 행동 판정에서 펌블을 냈을 때 | 효과: 해당 펌블을 무효로 하고 단순 실패로 변경 | 횟수: 세션당 1회",
      "마법사": "《마법사》 타이밍: 캐릭터 제작 시 | 효과: 마법 스킬 목록에서 마법 스킬 1개를 추가로 습득할 자격 획득(실제 선택은 별도) | 횟수: 설정 시 1회"
    }
  };

  var magicSkillCommands = {
    "텔레포트": "《텔레포트》 타이밍: 당신의 턴 | 효과: 이동력과 무관하게 같은 비공정 선내의 임의의 칸으로 순간이동(파츠 없음 칸, 다른 캐릭터가 있는 칸은 불가) | 횟수: 마법 코스트 5 소모 시 사용",
    "클레어보이언스": "《클레어보이언스》 타이밍: 당신이 행동 판정을 할 때 | 효과: 판정 주사위를 모두 굴린 직후 그 주사위 전부를 다시 굴림 | 횟수: 마법 코스트 3 소모, 같은 타이밍 중복 사용 가능",
    "텔레키네시스": "《텔레키네시스》 타이밍: 당신의 턴 | 효과: 액션으로 선언, 같은 비공정 선내의 임의의 파츠 1개를 거리와 무관하게 원격으로 작동하여 그 파츠 효과 사용 | 횟수: 마법 코스트 5 소모",
    "파이로키네시스": "《파이로키네시스》 타이밍: 당신의 턴 | 효과: 액션으로 마법공격 선언, 목표 비공정에 D(화재)/1 대미지 부여 | 횟수: 마법 코스트 5 소모",
    "레비테이션": "《레비테이션》 타이밍: 퀘스트 페이즈 | 효과: 그 라운드 동안 비행 능력 획득(라운드 종료 시 해제) | 횟수: 마법 코스트 1 소모",
    "텔레파시": "《텔레파시》 타이밍: 다른 캐릭터가 행동 판정을 할 때 | 효과: 그 캐릭터에 대한 유대 최대 여부와 무관하게 판정 지원을 선언하고, 유대에 지원 체크를 붙이지 않음 | 횟수: 마법 코스트 2 소모"
  };

  // 선택된 개성 스킬
  var selectedPersonalitySkills = [];
  var cardSelectedKeys = new Set();

  document.addEventListener("DOMContentLoaded", function () {
    var raceSelect = document.getElementById("raceSelect");
    var raceSkillSelect = document.getElementById("raceSkillSelect");
    var mixedRaceRow = document.getElementById("mixedRaceRow");
    var extraRaceSelect = document.getElementById("extraRaceSelect");
    var extraRaceSkillSelect = document.getElementById("extraRaceSkillSelect");

    var specializedAbilitySelect = document.getElementById("specializedAbility");
    var specializedAbilitySelect2 = document.getElementById("specializedAbility2");
    var spec2Wrapper = document.getElementById("spec2Wrapper");
    var weakAbilitySelect = document.getElementById("weakAbility");
    var weakHint = document.getElementById("weakHint");

    var personalityCardsContainer = document.getElementById("personalityCardsContainer");
    var personalitySlotsContainer = document.getElementById("personalitySlotsContainer");
    var personalityPreview = document.getElementById("personalityPreview");
    var personalityCountInfo = document.getElementById("personalityCountInfo");
    var cardModeStatus = document.getElementById("cardModeStatus");

    var magicSkillSelect = document.getElementById("magicSkillSelect");
    var magicSkillDesc = document.getElementById("magicSkillDesc");
    var raceFeatureDesc = document.getElementById("raceFeatureDesc");
    var raceSkillDesc = document.getElementById("raceSkillDesc");
    var extraRaceSkillDesc = document.getElementById("extraRaceSkillDesc");
    var extraRaceSkillDescWrapper = document.getElementById("extraRaceSkillDescWrapper");

    var explorerSkillSelect = document.getElementById("explorerSkillSelect");
    var explorerSkillDesc = document.getElementById("explorerSkillDesc");

    var generateApiBtn = document.getElementById("generateApiBtn");
    var copyApiBtn = document.getElementById("copyApiBtn");

    // ------------------------------
    // 유틸
    // ------------------------------

    function isHuman() {
      return raceSelect.value === "모던 타임즈";
    }

    function requiredPersonalityCount() {
      return isHuman() ? 3 : 2;
    }

    function isCardMode() {
      return isHuman() && raceSkillSelect.value === "십인십색";
    }

    function rollD6() {
      return Math.floor(Math.random() * 6) + 1;
    }

    function getPersonalityDescription(category, skill) {
      var catMap = personalitySkillDescriptions[category] || {};
      return catMap[skill] || "";
    }

    function getMagicDescription(name) {
      return magicSkillCommands[name] || getMagicDescriptionFallback(name);
    }

    function getMagicDescriptionFallback(name) {
      var desc = "이 마법 스킬에 대한 상세 설명은 룰북을 참고해 주세요.";
      return desc;
    }

    function getRaceFeatureDescription(race) {
      return raceFeatureDescriptions[race] || "선택한 종족의 상세 정보는 룰북을 참고해 주세요.";
    }

    function getRaceSkillDescription(race, skill) {
      var map = raceSkillDescriptions[race] || {};
      return map[skill] || "선택한 종족 스킬의 상세 정보는 룰북을 참고해 주세요.";
    }

    function hasPersonality(category, skill) {
      return selectedPersonalitySkills.some(function (s) {
        return s && s.category === category && s.skill === skill;
      });
    }

    function hasSujae() {
      return hasPersonality("재능", "수재");
    }

    function hasCheonjae() {
      return hasPersonality("재능", "천재");
    }

    function hasJeonmun() {
      return hasPersonality("재능", "전문 분야");
    }

    function hasJigin() {
      return hasPersonality("재능", "직인 기질");
    }

    // ------------------------------
    // 종족 / 종족 스킬 UI
    // ------------------------------

    function populateRaceSkills() {
      var race = raceSelect.value;
      var skills = raceSkillMap[race] || [];
      raceSkillSelect.innerHTML = "";
      skills.forEach(function (name) {
        var opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        raceSkillSelect.appendChild(opt);
      });
      if (skills.length > 0) {
        raceSkillSelect.value = skills[0];
      }
    }

    // 혼혈용 추가 종족 / 종족 스킬 UI
    var extraRaceList = ["리틀러", "앤티크", "코펠리아", "퍼리", "플로레스"];

    function populateExtraRaceSkills() {
      var race = extraRaceSelect.value;
      extraRaceSkillSelect.innerHTML = "";
      var skills = raceSkillMap[race] || [];
      skills.forEach(function (name) {
        var opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        extraRaceSkillSelect.appendChild(opt);
      });
      if (skills.length > 0) {
        extraRaceSkillSelect.value = skills[0];
      }
    }

    function populateExtraRaceOptions() {
      extraRaceSelect.innerHTML = "";
      extraRaceList.forEach(function (race) {
        var opt = document.createElement("option");
        opt.value = race;
        opt.textContent = race;
        extraRaceSelect.appendChild(opt);
      });
      if (extraRaceList.length > 0) {
        extraRaceSelect.value = extraRaceList[0];
      }
      populateExtraRaceSkills();
    }

    function refreshMixedRaceUI() {
      var isMixed =
        raceSelect.value === "모던 타임즈" &&
        raceSkillSelect.value === "혼혈";

      if (isMixed) {
        mixedRaceRow.style.display = "flex";
        extraRaceSelect.disabled = false;
        extraRaceSkillSelect.disabled = false;
        if (!extraRaceSelect.value) {
          populateExtraRaceOptions();
        } else {
          populateExtraRaceSkills();
        }
      } else {
        mixedRaceRow.style.display = "none";
        extraRaceSelect.disabled = true;
        extraRaceSkillSelect.disabled = true;
        extraRaceSelect.value = "";
        extraRaceSkillSelect.value = "";
      }

      // 혼혈 상태에 따라 추가 종족 스킬 설명도 함께 갱신
      updateExtraRaceSkillDescription();
    }


    function updateRaceDescriptions() {
      var race = raceSelect.value;
      var raceSkill = raceSkillSelect.value;

      raceFeatureDesc.textContent = getRaceFeatureDescription(race);
      raceSkillDesc.textContent = raceSkill ?
        getRaceSkillDescription(race, raceSkill) :
        "종족 스킬을 선택하면 효과가 여기 표시됩니다.";
    }

        function updateExtraRaceSkillDescription() {
      // 혼혈 상태가 아니면 설명 박스를 숨기고 초기 문구로 되돌립니다.
      var isMixed =
        raceSelect.value === "모던 타임즈" &&
        raceSkillSelect.value === "혼혈";

      if (!isMixed) {
        if (extraRaceSkillDescWrapper) {
          extraRaceSkillDescWrapper.style.display = "none";
        }
        if (extraRaceSkillDesc) {
          extraRaceSkillDesc.textContent =
            "혼혈로 습득한 추가 종족 스킬의 효과가 여기 표시됩니다.";
        }
        return;
      }

      // 혼혈일 때만 설명 표시
      if (extraRaceSkillDescWrapper) {
        extraRaceSkillDescWrapper.style.display = "block";
      }

      var extraRace = extraRaceSelect.value;
      var extraSkill = extraRaceSkillSelect.value;

      if (extraRace && extraSkill) {
        extraRaceSkillDesc.textContent =
          getRaceSkillDescription(extraRace, extraSkill);
      } else {
        extraRaceSkillDesc.textContent =
          "혼혈로 습득한 추가 종족 스킬의 효과가 여기 표시됩니다.";
      }
    }


    // ------------------------------
    // 마법 스킬 UI
    // ------------------------------

    function populateMagicSkills() {
      magicSkills.forEach(function (name) {
        var opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        magicSkillSelect.appendChild(opt);
      });
    }

    function needsMagicSkill() {
      return raceSelect.value === "앤티크" || hasPersonality("경력", "마법사");
    }

    function isMagicUnlocked() {
      return raceSelect.value === "앤티크" || hasPersonality("경력", "마법사");
    }

    function updateMagicUI() {
      var magicHint = document.getElementById("magicHint");
      var unlocked = isMagicUnlocked();
      var needed = needsMagicSkill();
      var selected = magicSkillSelect.value;

      if (!unlocked) {
        magicSkillSelect.disabled = true;
        magicSkillSelect.value = "";
        magicHint.classList.remove("danger");
        magicHint.classList.remove("success");
        magicHint.textContent =
          "현재 설정에서는 마법 스킬을 선택할 수 없습니다. (앤티크 종족 또는 개성 스킬 [경력] 마법사가 필요)";
        magicSkillDesc.textContent = "마법 스킬을 선택할 수 없는 상태입니다.";
      } else {
        magicSkillSelect.disabled = false;
        if (needed) {
          magicHint.classList.add("danger");
          magicHint.classList.remove("success");
          magicHint.textContent =
            "현재 설정에서는 마법 스킬 1개를 반드시 선택해야 합니다. (앤티크 종족 또는 [경력] 마법사 보유)";
        } else {
          magicHint.classList.remove("danger");
          magicHint.classList.add("success");
          magicHint.textContent =
            "마법 스킬을 선택할 수 있습니다. 1개를 선택하는 것을 권장합니다.";
        }

        if (selected) {
          magicSkillDesc.textContent = getMagicDescription(selected);
        } else {
          magicSkillDesc.textContent = "마법 스킬을 선택하면 상세 설명이 표시됩니다.";
        }
      }
    }

    // ------------------------------
    // 특화/취약 관련
    // ------------------------------

    function canHaveTwoSpecialized() {
      var two = false;
      if (
        (raceSelect.value === "모던 타임즈" && raceSkillSelect.value === "적응력") ||
        hasCheonjae()
      ) {
        two = true;
      }
      return two;
    }

    function needsWeakAbility() {
      return !hasSujae();
    }

    function refreshAbilityConstraints() {
      var canTwo = canHaveTwoSpecialized();
      var needWeak = needsWeakAbility();

      if (canTwo) {
        spec2Wrapper.style.display = "block";
        specializedAbilitySelect2.disabled = false;
      } else {
        spec2Wrapper.style.display = "none";
        specializedAbilitySelect2.disabled = true;
      }

      if (needWeak) {
        weakAbilitySelect.disabled = false;
        weakHint.textContent =
          "현재 설정에서는 취약 능력 1개를 반드시 선택해야 합니다. (개성 스킬 [재능] 수재가 없기 때문)";
        weakHint.classList.add("danger");
        weakHint.classList.remove("success");
      } else {
        weakAbilitySelect.disabled = true;
        weakAbilitySelect.value = "";
        weakHint.textContent =
          "개성 스킬 [재능] 수재 덕분에 이 캐릭터는 취약 능력이 없습니다.";
        weakHint.classList.remove("danger");
        weakHint.classList.add("success");
      }
    }

    function getAbilityConfig() {
      var spec1 = specializedAbilitySelect.value;
      var spec2Raw = specializedAbilitySelect2.value;
      var weak = weakAbilitySelect.disabled ? "" : weakAbilitySelect.value;
      var canTwo = canHaveTwoSpecialized();
      var needWeak = needsWeakAbility();

      var specializedSet = new Set();
      if (spec1) {
        specializedSet.add(spec1);
      }
      if (canTwo && spec2Raw && spec2Raw !== spec1) {
        specializedSet.add(spec2Raw);
      }

      return {
        specializedSet: specializedSet,
        spec1: spec1,
        spec2: canTwo ? spec2Raw : "",
        weak: weak,
        canTwo: canTwo,
        needWeak: needWeak
      };
    }

    function buildAbilitySummary() {
      var cfg = getAbilityConfig();
      var specializedSet = cfg.specializedSet;
      var weak = cfg.weak;
      var abilities = ["기술", "감각", "교양", "신체"];

      var parts = abilities.map(function (name) {
        if (specializedSet.has(name)) {
          return name + "(특화)";
        } else if (weak && name === weak) {
          return name + "(취약)";
        } else {
          return name + "(보통)";
        }
      });

      return parts.join(", ");
    }

    function buildAbilityLineForMemo() {
      var cfg = getAbilityConfig();
      var specializedSet = cfg.specializedSet;
      var weak = cfg.weak;

      var specList = Array.from(specializedSet);
      var specText;
      if (specList.length === 0) {
        specText = "특화 없음";
      } else if (specList.length === 1) {
        specText = specList[0] + " 특화";
      } else {
        specText = specList.join(", ") + " 특화";
      }

      var weakText;
      if (weak) {
        weakText = weak + " 취약";
      } else {
        weakText = "취약 없음";
      }

      return specText + ", " + weakText;
    }

    // ------------------------------
    // 개성 스킬 슬롯 / 카드 모드
    // ------------------------------

    function ensurePersonalityArraySize() {
      var need = requiredPersonalityCount();
      while (selectedPersonalitySkills.length < need) {
        selectedPersonalitySkills.push(null);
      }
      if (selectedPersonalitySkills.length > need) {
        selectedPersonalitySkills = selectedPersonalitySkills.slice(0, need);
      }
    }

    function buildSlotsUI() {
      personalitySlotsContainer.innerHTML = "";

      if (isCardMode()) {
        personalitySlotsContainer.style.display = "none";
        return;
      }

      personalitySlotsContainer.style.display = "flex";
      ensurePersonalityArraySize();
      var need = requiredPersonalityCount();

      for (var i = 0; i < need; i++) {
        (function (slotIndex) {
          var slot = document.createElement("div");
          slot.className = "personality-slot";

          var labelSpan = document.createElement("span");
          labelSpan.className = "personality-slot-label";
          labelSpan.textContent = "슬롯 " + (slotIndex + 1);

          var textSpan = document.createElement("span");
          textSpan.className = "personality-slot-text";
          textSpan.id = "personalitySlotText-" + slotIndex;

          var btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "이 슬롯 굴리기 (2d6)";
          btn.addEventListener("click", function () {
            rollPersonalityForSlot(slotIndex);
          });

          slot.appendChild(labelSpan);
          slot.appendChild(textSpan);
          slot.appendChild(btn);
          personalitySlotsContainer.appendChild(slot);
        })(i);
      }

      updateSlotTexts();
    }

    function updateSlotTexts() {
      var need = requiredPersonalityCount();
      ensurePersonalityArraySize();

      for (var i = 0; i < need; i++) {
        var s = selectedPersonalitySkills[i];
        var el = document.getElementById("personalitySlotText-" + i);
        if (!el) continue;

        if (!s) {
          el.textContent = "아직 결정되지 않았습니다. 버튼을 눌러 2d6으로 개성 스킬을 굴립니다.";
        } else {
          var desc = getPersonalityDescription(s.category, s.skill);
          el.textContent = "[" + s.category + "] " + s.skill +
            (desc ? " - " + desc : "");
        }
      }
    }

    function rollPersonalityForSlot(slotIndex) {
      var need = requiredPersonalityCount();
      ensurePersonalityArraySize();

      var safety = 200;
      while (safety-- > 0) {
        var dieCategory = rollD6();
        var dieIndex = rollD6();

        var categoryIndex = dieCategory - 1;
        if (categoryIndex < 0 || categoryIndex >= personalityCategories.length) {
          continue;
        }
        var catName = personalityCategories[categoryIndex];
        var skills = personalitySkills[catName] || [];
        var skillIndex = dieIndex - 1;
        if (skillIndex < 0 || skillIndex >= skills.length) {
          continue;
        }
        var skillName = skills[skillIndex];

        if (catName !== "재능") {
          var exists = selectedPersonalitySkills.some(function (s, idx) {
            return s && idx !== slotIndex && s.category === catName && s.skill === skillName;
          });
          if (exists) {
            continue;
          }
        }

        selectedPersonalitySkills[slotIndex] = {
          category: catName,
          skill: skillName
        };
        break;
      }
      if (safety <= 0) {
        console.error("Failed to assign personality skill after many attempts.");
      }

      updateSlotTexts();
      updatePersonalityPreview();
    }

    function buildSkillCards() {
      personalityCardsContainer.innerHTML = "";
      var needCount = requiredPersonalityCount();

      personalityCategories.forEach(function (cat) {
        var wrapper = document.createElement("div");
        wrapper.className = "skill-category-block";

        var title = document.createElement("div");
        title.className = "skill-category-title";
        title.textContent = cat;

        var list = document.createElement("div");
        list.className = "skill-card-list";

        var skills = personalitySkills[cat] || [];
        skills.forEach(function (skillName, idx) {
          var key = cat + "::" + idx;
          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "skill-card";
          btn.textContent = skillName;
          btn.dataset.category = cat;
          btn.dataset.index = String(idx);

          if (cardSelectedKeys.has(key)) {
            btn.classList.add("selected");
          }

          btn.addEventListener("click", function () {
            var c = btn.dataset.category;
            var i = parseInt(btn.dataset.index, 10);
            var keyInner = c + "::" + i;

            if (cardSelectedKeys.has(keyInner)) {
              cardSelectedKeys.delete(keyInner);
            } else {
              if (cardSelectedKeys.size >= needCount) {
                return;
              }
              cardSelectedKeys.add(keyInner);
            }

            if (cardSelectedKeys.has(keyInner)) {
              btn.classList.add("selected");
            } else {
              btn.classList.remove("selected");
            }

            syncSelectedPersonalityFromCards();
          });

          list.appendChild(btn);
        });

        wrapper.appendChild(title);
        wrapper.appendChild(list);
        personalityCardsContainer.appendChild(wrapper);
      });

      syncSelectedPersonalityFromCards();
    }

    function syncSelectedPersonalityFromCards() {
      selectedPersonalitySkills = [];
      var need = requiredPersonalityCount();

      var currentSelectedCount = 0;
      cardSelectedKeys.forEach(function (key) {
        if (currentSelectedCount >= need) return;

        var parts = key.split("::");
        var cat = parts[0];
        var idx = parseInt(parts[1], 10);
        var skills = personalitySkills[cat] || [];
        var name = skills[idx] || "";

        if (name) {
          selectedPersonalitySkills.push({
            category: cat,
            skill: name
          });
          currentSelectedCount++;
        }
      });

      while (selectedPersonalitySkills.length < need) {
        selectedPersonalitySkills.push(null);
      }
      if (selectedPersonalitySkills.length > need) {
        selectedPersonalitySkills = selectedPersonalitySkills.slice(0, need);
      }

      updatePersonalityPreview();
    }

    function refreshCardModeUI() {
      var needCount = requiredPersonalityCount();
      var card = isCardMode();

      if (card) {
        personalityCardsContainer.style.display = "block";
        cardModeStatus.textContent =
          "카드 모드입니다. 원하는 개성 스킬을 최대 " +
          needCount + "개까지 직접 선택할 수 있습니다. 같은 스킬을 다시 클릭하면 해제됩니다.";
        cardSelectedKeys.clear();
        selectedPersonalitySkills = [];
        buildSkillCards();
        personalitySlotsContainer.style.display = "none";
      } else {
        personalityCardsContainer.style.display = "none";
        cardModeStatus.textContent = "";
        cardSelectedKeys.clear();
        ensurePersonalityArraySize();
        buildSlotsUI();
      }

      updatePersonalityPreview();
    }

    function updatePersonalityPreview() {
      var need = requiredPersonalityCount();
      ensurePersonalityArraySize();
      var count = selectedPersonalitySkills.filter(function (s) { return !!s; }).length;
      personalityCountInfo.textContent = count + " / " + need;

      if (count === 0) {
        personalityPreview.textContent = "아직 선택된 개성 스킬이 없습니다.";
      } else {
        var lines = [];
        selectedPersonalitySkills.forEach(function (s, idx) {
          if (!s) return;
          var desc = getPersonalityDescription(s.category, s.skill);
          var line = String(idx + 1) + ". [" + s.category + "] " + s.skill;
          if (desc) {
            line += " - " + desc;
          }
          lines.push(line);
        });
        personalityPreview.textContent = lines.join("\n");
      }

      refreshAbilityConstraints();
      updateMagicUI();
      updateSlotTexts();
    }

    // ------------------------------
    // 탐공사 스킬 설명
    // ------------------------------

    function updateExplorerDescription() {
      var name = explorerSkillSelect.value;
      if (explorerSkillCommands[name]) {
        var full = explorerSkillCommands[name];
        var parts = full.split("|");
        explorerSkillDesc.textContent = parts.slice(1).join("|") || full;
      } else {
        explorerSkillDesc.textContent =
          "선택한 탐공사 스킬의 상세 정보는 룰북을 참고해 주세요.";
      }
    }

    function sanitizeDescription(text) {
      if (!text) return "";
      return String(text).replace(/\n/g, " ");
    }

    // ------------------------------
    // 판정 매크로 생성
    // ------------------------------

    function buildCommandsText() {
      var race = raceSelect.value;
      var raceSkill = raceSkillSelect.value;
      var magicSkill = magicSkillSelect.value;
      var explorerSkill = explorerSkillSelect.value;
      var extraRace = extraRaceSelect.value;
      var extraRaceSkill = extraRaceSkillSelect.value;

      var abilitySummary = buildAbilitySummary();
      var abilityLine = buildAbilityLineForMemo();

      var cfg = getAbilityConfig();
      var specializedSet = cfg.specializedSet;
      var weak = cfg.weak;

      var hasJeonmunField = hasJeonmun();
      var hasJiginField = hasJigin();

      function decideMacro(abilityList) {
        var specCount = abilityList.filter(function (name) {
          return specializedSet.has(name);
        }).length;
        var weakCount = abilityList.filter(function (name) {
          return weak && weak === name;
        }).length;

        if (
          abilityList.length >= 2 &&
          specCount === abilityList.length &&
          hasJeonmunField
        ) {
          return "4SN";
        }

        if (
          abilityList.length >= 2 &&
          specCount >= 1 &&
          weakCount >= 1 &&
          hasJiginField
        ) {
          return "3SN";
        }

        if (specCount >= 1 && weakCount >= 1) {
          return "3SN2";
        } else if (specCount >= 1) {
          return "3SN";
        } else if (weakCount >= 1) {
          return "SN2";
        } else {
          return "SN";
        }
      }

      var lines = [];

      lines.push("FT      펌블표");
      lines.push("NV      항행표");
      lines.push("");
      lines.push("항행 이벤트표");
      lines.push("NEN     항행계");
      lines.push("NEE     조우계");
      lines.push("NEO     선내계");
      lines.push("NEH     곤란계");
      lines.push("NEL     장거리 여행계");
      lines.push("");
      lines.push("1D6     【생명점】 판정");
      lines.push("Dx/y    데미지 체크");
      lines.push("");

      lines.push(decideMacro(["기술", "감각"]) + "    포격 판정【기술 / 감각】");
      lines.push(decideMacro(["기술", "교양"]) + "    수리 판정【기술 / 교양】");
      lines.push(decideMacro(["감각", "교양"]) + "    조타 판정【감각 / 교양】");
      lines.push(decideMacro(["신체", "기술"]) + "    백병 판정【신체 / 기술】");
      lines.push(decideMacro(["신체", "기술"]) + "    침입 판정【신체 / 기술】");
      lines.push(decideMacro(["신체", "감각"]) + "    정찰 판정【신체 / 감각】");
      lines.push(decideMacro(["신체", "감각"]) + "    진동 판정【신체 / 감각】");
      lines.push(decideMacro(["신체", "교양"]) + "    소화 판정【신체 / 교양】");
      lines.push("");

      lines.push("탐공사 스킬");
      if (explorerSkill) {
        var exCmd = explorerSkillCommands[explorerSkill];
        if (exCmd) {
          lines.push(exCmd);
        } else {
          lines.push(
            "《" +
              explorerSkill +
              "》 타이밍: - | 효과: - | 횟수: -"
          );
        }
      } else {
        lines.push("《탐공사 스킬 미선택》 타이밍: - | 효과: - | 횟수: -");
      }
      lines.push("");

      var raceDesc = getRaceFeatureDescription(race);
      lines.push("종족 특징");
      lines.push(
        "《" +
          race +
          "》 타이밍: 항상 | 효과: " +
          sanitizeDescription(raceDesc) +
          " | 횟수: 상시 효과"
      );
      lines.push("");

      if (raceSkill) {
        lines.push("종족 스킬");
        var raceMapCmd = raceSkillCommands[race] || {};
        var rCmd = raceMapCmd[raceSkill];
        if (rCmd) {
          lines.push(rCmd);
        } else {
          var rSkillDesc = getRaceSkillDescription(race, raceSkill);
          lines.push(
            "《" +
              raceSkill +
              "》 타이밍: - | 효과: " +
              sanitizeDescription(rSkillDesc) +
              " | 횟수: -"
          );
        }

        if (
          race === "모던 타임즈" &&
          raceSkill === "혼혈" &&
          extraRace &&
          extraRaceSkill
        ) {
          var extraRaceMapCmd = raceSkillCommands[extraRace] || {};
          var extraCmd = extraRaceMapCmd[extraRaceSkill];
          if (extraCmd) {
            lines.push(extraCmd);
          } else {
            var extraDesc = getRaceSkillDescription(extraRace, extraRaceSkill);
            lines.push(
              "《" +
                extraRaceSkill +
                "》 타이밍: - | 효과: " +
                sanitizeDescription(extraDesc) +
                " | 횟수: -"
            );
          }
        }

        lines.push("");
      }

      lines.push("능력");
      lines.push("- " + abilityLine);
      lines.push("- 요약: " + abilitySummary);
      lines.push("");

      lines.push("개성 스킬");
      var anyPersonality = false;
      selectedPersonalitySkills.forEach(function (s) {
        if (!s) return;
        anyPersonality = true;
        var cat = s.category;
        var skill = s.skill;
        var catMap = personalitySkillCommands[cat] || {};
        var pCmd = catMap[skill];
        if (pCmd) {
          lines.push(pCmd);
        } else {
          var desc = getPersonalityDescription(cat, skill);
          lines.push(
            "《" +
              skill +
              "》 타이밍: - | 효과: " +
              sanitizeDescription(desc) +
              " | 횟수: -"
          );
        }
      });
      if (!anyPersonality) {
        lines.push("《개성 스킬 미선택》 타이밍: - | 효과: - | 횟수: -");
      }

      if (magicSkill) {
        lines.push("");
        lines.push("마법 스킬");
        var mCmd = magicSkillCommands[magicSkill];
        if (mCmd) {
          lines.push(mCmd);
        } else {
          var mDesc = getMagicDescription(magicSkill);
          lines.push(
            "《" +
              magicSkill +
              "》 타이밍: - | 효과: " +
              sanitizeDescription(mDesc) +
              " | 횟수: -"
          );
        }
      }

      return lines.join("\n");
    }

    // ------------------------------
    // 메모 텍스트
    // ------------------------------

    function buildMemoText() {
      var charName = document.getElementById("charName").value.trim();
      var desc = document.getElementById("charDescription").value.trim();
      var race = raceSelect.value;
      var abilityLine = buildAbilityLineForMemo();

      var lines = [];
      if (charName) {
        lines.push(charName);
      }
      if (desc) {
        lines.push(desc);
      }
      if (charName || desc) {
        lines.push("");
      }

      lines.push("호 소속");
      lines.push("");
      lines.push("무용담 장르 | 커리어");
      lines.push("종족 | " + race);
      lines.push("");
      lines.push(abilityLine);
      lines.push("");
      lines.push("유대");
      for (var i = 0; i < 6; i++) {
        lines.push("에 대한 유대");
      }
      lines.push("");
      lines.push("배드 스테이터스");

      return lines.join("\n");
    }

    // ------------------------------
    // 능력치 기반 파라미터 / 스테이터스
    // ------------------------------

    function buildCcfCharacterData() {
      var charName = document.getElementById("charName").value.trim();
      var cfg = getAbilityConfig();
      var specializedSet = cfg.specializedSet;
      var weak = cfg.weak;

      var abilities = ["기술", "감각", "교양", "신체"];

      var params = abilities.map(function (name) {
        var v;
        if (specializedSet.has(name)) {
          v = "1";
        } else if (weak && name === weak) {
          v = "2";
        } else {
          v = "0";
        }
        return {
          label: name,
          value: v
        };
      });

      var race = raceSelect.value;
      var raceSkill = raceSkillSelect.value;
      var explorerSkill = explorerSkillSelect.value;

      var maxHp = 10;
      var move = 3;

      if (race === "리틀러") {
        move += 1;
        if (raceSkill === "고소 작업의 명수") {
          move += 1;
        }
      }
      if (race === "퍼리") {
        maxHp += 3;
      }
      if (race === "모던 타임즈" && raceSkill === "혼혈") {
        maxHp -= 2;
      }

      if (explorerSkill === "비계공") {
        move += 1;
      }

      selectedPersonalitySkills.forEach(function (s) {
        if (!s) return;
        if (s.category === "재능" && s.skill === "곡예") {
          move += 1;
        }
        if (s.category === "재능" && s.skill === "강건함") {
          maxHp += 2;
        }
      });

      if (maxHp < 1) {
        maxHp = 1;
      }

      var status = [
        { label: "생명점", value: maxHp, max: maxHp },
        { label: "유대", value: 0, max: 6 },
        { label: "BS", value: 0, max: 5 },
        { label: "이동력", value: move, max: 0 }
      ];

      var commands = buildCommandsText();
      var memoText = buildMemoText();

      var data = {
        kind: "character",
        data: {
          name: charName || "이름 미정",
          memo: memoText,
          initiative: 0,
          status: status,
          params: params,
          commands: commands
        }
      };

      return data;
    }

    // ------------------------------
    // 입력 검증
    // ------------------------------

    function validateInputs() {
      var charName = document.getElementById("charName").value.trim();
      var cfg = getAbilityConfig();
      var spec1 = cfg.spec1;
      var spec2 = cfg.spec2;
      var weak = cfg.weak;
      var canTwo = cfg.canTwo;
      var needWeak = cfg.needWeak;

      var race = raceSelect.value;
      var raceSkill = raceSkillSelect.value;

      if (!charName) {
        alert("캐릭터 이름을 입력해 주세요.");
        return false;
      }

      if (!spec1) {
        alert("특화 능력 1개를 선택해 주세요.");
        return false;
      }

      if (canTwo) {
        if (!spec2) {
          alert("추가 특화 능력을 반드시 선택해야 합니다.");
          return false;
        }
        if (spec2 === spec1) {
          alert("추가 특화 능력은 첫 번째 특화 능력과 다른 능력을 선택해야 합니다.");
          return false;
        }
      }

      if (needWeak) {
        if (!weak) {
          alert("현재 설정에서는 취약 능력 1개를 반드시 선택해야 합니다.");
          return false;
        }
        if (weak === spec1 || (canTwo && spec2 && weak === spec2)) {
          alert("취약 능력은 특화 능력과 다른 능력이어야 합니다.");
          return false;
        }
      } else {
        if (weak) {
          alert("개성 스킬 [재능] 수재 덕분에 이 캐릭터는 취약 능력을 가질 수 없습니다.");
          return false;
        }
      }

      if (race === "모던 타임즈" && raceSkill === "혼혈") {
        if (!extraRaceSelect.value) {
          alert("종족 스킬 [혼혈]을 선택했으면 추가 종족을 반드시 선택해야 합니다.");
          return false;
        }
        if (!extraRaceSkillSelect.value) {
          alert("종족 스킬 [혼혈]을 선택했으면 추가 종족 스킬도 반드시 선택해야 합니다.");
          return false;
        }
      }

      var needPersonality = requiredPersonalityCount();
      var count = selectedPersonalitySkills.filter(function (s) { return !!s; }).length;
      if (count !== needPersonality) {
        alert("개성 스킬을 정확히 " + needPersonality + "개 선택해야 합니다.");
        return false;
      }

      if (needsMagicSkill()) {
        if (!magicSkillSelect.value) {
          alert("현재 설정에서는 마법 스킬 1개를 반드시 선택해야 합니다.");
          return false;
        }
      } else {
        if (magicSkillSelect.value && !isMagicUnlocked()) {
          alert("마법 스킬을 선택할 수 없는 상태입니다. 선택을 해제해 주세요.");
          return false;
        }
      }

      return true;
    }

    // ------------------------------
    // 이벤트 바인딩
    // ------------------------------

    raceSelect.addEventListener("change", function () {
      populateRaceSkills();
      refreshCardModeUI();
      refreshAbilityConstraints();
      updateMagicUI();
      updateRaceDescriptions();
      refreshMixedRaceUI();
      if (raceSkillSelect.options.length > 0) {
        raceSkillSelect.value = raceSkillSelect.options[0].value;
      }
      updateExtraRaceSkillDescription();
    });

    raceSkillSelect.addEventListener("change", function () {
      refreshCardModeUI();
      refreshAbilityConstraints();
      updateMagicUI();
      updateRaceDescriptions();
      refreshMixedRaceUI();
      updateExtraRaceSkillDescription();
    });

    extraRaceSelect.addEventListener("change", function () {
      populateExtraRaceSkills();
      updateExtraRaceSkillDescription();
    });

    extraRaceSkillSelect.addEventListener("change", function () {
      updateExtraRaceSkillDescription();
    });


    magicSkillSelect.addEventListener("change", function () {
      updateMagicUI();
    });

    explorerSkillSelect.addEventListener("change", function () {
      updateExplorerDescription();
    });

    specializedAbilitySelect.addEventListener("change", function () {
      refreshAbilityConstraints();
    });

    specializedAbilitySelect2.addEventListener("change", function () {
      refreshAbilityConstraints();
    });

    weakAbilitySelect.addEventListener("change", function () {
      refreshAbilityConstraints();
    });

    generateApiBtn.addEventListener("click", function () {
      var apiOutput = document.getElementById("apiOutput");
      var copyStatus = document.getElementById("copyStatus");

      copyStatus.textContent = "";

      if (!validateInputs()) {
        return;
      }

      var obj = buildCcfCharacterData();
      var jsonStr = JSON.stringify(obj, null, 2);
      apiOutput.value = jsonStr;
      copyStatus.textContent = "생성이 완료되었습니다. JSON 전체를 복사해서 코코포리아에 붙여넣으세요.";
    });

    copyApiBtn.addEventListener("click", function () {
      var apiOutput = document.getElementById("apiOutput");
      var copyStatus = document.getElementById("copyStatus");
      var text = apiOutput.value;

      copyStatus.textContent = "";

      if (!text.trim()) {
        copyStatus.textContent = "먼저 JSON을 생성해 주세요.";
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(function () {
            copyStatus.textContent = "클립보드 복사 완료.";
          })
          .catch(function () {
            apiOutput.select();
            try {
              var ok = document.execCommand("copy");
              if (ok) {
                copyStatus.textContent = "클립보드 복사 완료.";
              } else {
                copyStatus.textContent = "클립보드 복사에 실패했습니다. 직접 선택해서 복사해 주세요.";
              }
            } catch (e) {
              copyStatus.textContent = "클립보드 복사에 실패했습니다. 직접 선택해서 복사해 주세요.";
            }
          });
      } else {
        apiOutput.select();
        try {
          var ok = document.execCommand("copy");
          if (ok) {
            copyStatus.textContent = "클립보드 복사 완료.";
          } else {
            copyStatus.textContent = "클립보드 복사에 실패했습니다. 직접 선택해서 복사해 주세요.";
          }
        } catch (e) {
          copyStatus.textContent = "클립보드 복사에 실패했습니다. 직접 선택해서 복사해 주세요.";
        }
      }
    });

    // ------------------------------
    // 초기화
    // ------------------------------
    populateRaceSkills();
    populateMagicSkills();
    ensurePersonalityArraySize();
    buildSlotsUI();
    updatePersonalityPreview();
    refreshAbilityConstraints();
    updateMagicUI();
    refreshCardModeUI();
    updateRaceDescriptions();
    updateExplorerDescription();
    refreshMixedRaceUI();
    updateExtraRaceSkillDescription();
  });
</script>
</body>
</html>
